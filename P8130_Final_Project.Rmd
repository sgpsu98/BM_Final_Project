---
title: "P8130 Final Project"
author: "Pengyuan Su (ps3195), Shuhong Xiang (sx2289), Yali Zhai (yz3959), Zhixing Wu (zw2709)"
date: "12/6/2020"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(purrr)
library(olsrr)
library(dvmisc)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```


```{r load_libraries}
library(tidyverse)
library(modelr)
library(arsenal)
library(broom)
library(modelr)
library(patchwork)
library(mgcv)
library(faraway)
library(skimr)
```

# Abstract 


# Introduction
Hate crime is a significant issue under the present circumstances. There exist multiple variables related to hate crime. In this project, we intend to find the relationships between the hate crime rate and the eight variables. Among the eight variables, income status is about unemployment level, medians of household income, and Gini index in the dataset. Especially, the Gini index is a measure of the distribution of income across a population developed by the Italian statistician Corrado Gini in 1912. [1] In real life, the high-valued Gini index implies the high levels of inequality in the whole society. Also, the high unemployment rate will lower the medians of household income. People without employment are more likely to participate in hate crime. [2] Besides, the education level matters in income status. A higher level of education status, like the high-school degree in this study, will lead to an occupation with a higher salary, which can increase the medians of household income and decrease unemployment. 





Hate crime, according to website information (https://hatecrime.campaign.gov.uk/), is regarded as the criminal offence motivated by hostility or prejudice of others’ some characteristics, including race, religion, sexual orientation, transgender identity, disability. And our project mainly emphasizes on the possible variables which might have close relation with the hate crime rate.






The race consideration might become the most common cause of hate crime. Based on the statistics provided (https://law.jrank.org/pages/12135/Race-Ethnicity-Hate-Crimes.html ), hate crimes resulting from race were about 49 percent in 2002 and 67 percent of victims attacked for racial problems were black Americans.




It is pointed out in this article(https://www.assignmentpoint.com/arts/social-science/the-role-of-urbanization-in-increasing-crime-in-urban-area-2.html) that the crime and urbanization seem to be correlated in terms of sociological aspects since it have be linked between criminal cases and the socio-economic development levels.





https://safer-america.com/map-of-reported-hate-crimes-in-the-u-s-a/
According to the Uniform Crime Reporting Program’s Hate Crime Statistics Program, all the hate crimes reported to the FBI in 2017 of all the states except Hawaii were shown, and the Pennsylvania had 1488 cases and ranked the first. While in terms of the Hate Crimes per 100,000, the District of Columbia had the largest figure of 27.81.


# Data Analysis


## Tidy:

`rate`: hate_crimes_per_100k_splc

`med_income`: median_household_income

`high_degree`: perc_population_with_high_school_degree

`non_citizen`: perc_non_citizen

`non_white`: perc_non_white


```{r import data}
hc_df = 
  read_csv(here::here("data/HateCrimes.csv")) %>% 
  janitor::clean_names() %>% 
  mutate(hate_crimes_per_100k_splc = as.numeric(hate_crimes_per_100k_splc)) %>% 
  drop_na() %>% 
  rename(., 
         rate = hate_crimes_per_100k_splc, 
         med_income = median_household_income, 
         high_degree = perc_population_with_high_school_degree, 
         non_citizen = perc_non_citizen, 
         non_white = perc_non_white)

head(hc_df)
```

Description by table?

```{r}
my_controls <- tableby.control(
               total = T, # do you wanna show he overall col?
               test=F,  # No test p-values yet
               numeric.stats = c("meansd", "medianq1q3", "range", "Nmiss2"), # for the continuous var. (a.k.a numeric var.) 
               cat.stats = c("countpct", "Nmiss2"), # for categorical var., we select the count, percentage, and missing values.
               stats.labels = list(
               meansd = "Mean (SD)",
               medianq1q3 = "Median (Q1, Q3)",
               range = "Min - Max",
               Nmiss2 = "Missing",
               countpct = "N (%)"))


## or use skim()


#summary(tab1, title = "Descriptive statistics ", text = T,  digits = 1) %>%  knitr::kable()   
```


### change "unemployment" and "urbanization" from characters to corresponding numbers

use 1 and 2 to denote the level low and high

```{r}
hc_df = 
  hc_df %>% 
  mutate(
    unemployment = case_when(
      unemployment == "low" ~ 1,
      unemployment == "high" ~ 2)
  ) %>% 
  mutate(
    urbanization = case_when(
      urbanization == "low" ~ 1,
      urbanization == "high" ~ 2)
  ) %>% 
  mutate(urbanization = as.factor(urbanization),
         unemployment = as.factor(unemployment)) %>% 
  select(-state)
```


## Plot distribution of hate crimes rate

```{r plot distribution of rate}
hc_df %>% 
  ggplot(aes(x = rate, y = ..density..)) +
  geom_histogram(fill = "blue", alpha = .4) +
  geom_density(aes( x = rate, y = ..density..)) +
  theme_bw() +
  labs(title = "Distribution for hate crimes per 100k",
       x = "hate crimes per 100k splc",
       y = " Count") +
  theme(plot.title = element_text(hjust = .5 ))
```


```{r plot distribution of rate 2}
hc_df_log = 
  hc_df %>% 
  mutate(lg = log(rate)) %>% 
  select(-rate)

hc_df_log%>% 
  ggplot(aes(x = lg, y = ..density..)) +
  geom_histogram(fill = "blue", alpha = .4) +
  geom_density(aes( lg, y = ..density..)) +
  theme_bw() +
  labs(title = "Distribution for Log ",
       x = "Log (hate crimes per 100k splc)",
       y = " Count") +
  theme(plot.title = element_text(hjust = .5 ))


```

```{r}
# Histogram - notice the severe right skew
hist(hc_df_log$lg, xlab="log(hate crimes per 100k splc)", freq=T, col=2)

# Create a quantile-quantile plot (QQplot)
qqnorm(hc_df_log$lg, col=2, pch=19, cex=1.5)

# Add a straight line which passes through the first and third quartiles.
qqline(hc_df_log$lg, col = 1,lwd=2,lty=2)
```
Based on the QQ plot in terms of the log(hate crimes per 100k splc), the points are nearly distributed along the straight line, so there is not severe departure from the normality.

```{r}
# Perform Shapiro-Wilk test
shapiro.test(hc_df_log$lg)

```



H0: the log(hate crimes per 100k splc) is normally distributed
H1: the log(hate crimes per 100k splc) is not normally distributed

The W test statistic is 0.983 with p value of 0.7453.

Since the p value is greater than 0.05, so we fail to reject the null and we could conclude that the log(hate crimes per 100k splc) seems to be normally distributed under the significance level of 5%.








## Verify association

**income**

```{r}
income = 
 lm(rate ~ med_income, data = hc_df)
summary(income)
```
```{r}
income_ = 
  lm(lg ~ med_income, data = hc_df_log)
summary(income_)
```


**high school degree**

```{r}
degree = 
 lm(rate ~ high_degree, data = hc_df)

summary(degree)
```
```{r}
degree_ = 
 lm(lg ~ high_degree, data = hc_df_log)

summary(degree_)
```

**non citizen**

```{r}
noncitizen = 
 lm(rate ~ non_citizen, data = hc_df)

summary(noncitizen)
```
```{r}
noncitizen_ = 
 lm(lg ~ non_citizen, data = hc_df_log)

summary(noncitizen_)
```


**non white**

```{r}
nonwhite = 
 lm(rate ~ non_white, data = hc_df)

summary(nonwhite)
```
```{r}
nonwhite_ = 
 lm(lg ~ non_white, data = hc_df_log)

summary(nonwhite_)
```


**gini index**

```{r}
gini = 
 lm(rate ~ gini_index, data = hc_df)

summary(gini)
```
```{r}
gini_ = 
 lm(lg ~ gini_index, data = hc_df_log)

summary(gini_)
```

**unemployment**

```{r}
unemployment = 
 lm(rate ~ unemployment, data = hc_df)

summary(unemployment)
```
```{r}
unemployment_ = 
 lm(lg ~ unemployment, data = hc_df_log)

summary(unemployment_)
```


**urbanization**

```{r}
urbanization = 
 lm(rate ~ urbanization, data = hc_df)

summary(urbanization)
```


```{r}
urbanization_ = 
 lm(lg ~ urbanization, data = hc_df_log)

summary(urbanization_)
```

## MLR

```{r}

mult.fit = lm(rate ~ ., data = hc_df)
step(mult.fit, direction='backward')

```
rate ~ high_degree + gini_index



```{r}

mult.fit = lm(lg ~ ., data = hc_df_log)
step(mult.fit, direction='backward')


```
lg ~ high_degree + gini_index


```{r}
# ????
# three covariates
# rate ~ income + gini +unemployment
# log ~  income + degree
# aic ~ degree +gini

# focus on income + degree + gini and their interaction, maybe adjust for different levels of unemployment



```




## interaction
??

```{r}
interaction = 
  lm(rate ~ med_income + high_degree + gini_index + med_income * high_degree + med_income * gini_index + high_degree * gini_index + med_income * high_degree * gini_index, data = hc_df)
summary(interaction)
```


```{r}
interaction_ = 
  lm(lg ~ med_income + high_degree + gini_index + med_income * high_degree + med_income * gini_index + high_degree * gini_index + med_income * high_degree * gini_index, data = hc_df_log)
summary(interaction_)
```

## Correlation

```{r eval=FALSE, include=FALSE}

hc_df %>% cor() %>% round(., 2)
```

## regression of all numeric variables

```{r}
reg_all = lm(rate ~ med_income + high_degree + non_citizen + gini_index + non_white, data = hc_df)
 summary(reg_all)
```


## stepwise

```{r}

#hc_df$unemployment <-ifelse(hc_df$unemployment=="high",1,ifelse(hc_df$unemployment=="low", 0, NA))

#hc_df$urbanization <-ifelse(hc_df$urbanization=="high",1,ifelse(hc_df$urbanization=="low", 0, NA))

 #hc_df = 
 # hc_df %>% 
 # select(-state)  

model =  
  lm(rate ~ ., data = hc_df) 

 step(model, direction = 'backward')

```

## Forward

```{r}
# step1
fit1 <- lm(rate ~ unemployment, data = hc_df)
tidy(fit1)
fit2 <- lm(rate ~ urbanization, data = hc_df)
tidy(fit2)
fit3 <- lm(rate ~ med_income, data = hc_df)
tidy(fit3)
fit4 <- lm(rate ~ high_degree, data = hc_df)
tidy(fit4)
fit5 <- lm(rate ~ non_citizen, data = hc_df)
tidy(fit5)
fit6 <- lm(rate ~ gini_index, data = hc_df)
tidy(fit6)
fit7 <- lm(rate ~ non_white, data = hc_df)
tidy(fit7)

forward1 = lm(rate ~ gini_index, data = hc_df)

# step 2
fit1 <- update(forward1, . ~ . +unemployment)
tidy(fit1)
fit2 <- update(forward1, . ~ . +urbanization)
tidy(fit2)
fit3 <- update(forward1, . ~ . +med_income)
tidy(fit3)
fit4 <- update(forward1, . ~ . +high_degree)
tidy(fit4)
fit5 <- update(forward1, . ~ . +non_citizen)
tidy(fit5)
fit6 <- update(forward1, . ~ . +non_white)
tidy(fit6)

forward2 = update(forward1, . ~ . +high_degree)

#step 3
fit1 <- update(forward2, . ~ . +unemployment)
tidy(fit1)
fit2 <- update(forward2, . ~ . +urbanization)
tidy(fit2)
fit3 <- update(forward2, . ~ . +med_income)
tidy(fit3)
fit4 <- update(forward2, . ~ . +non_citizen)
tidy(fit4)
fit5 <- update(forward2, . ~ . +non_white)
tidy(fit5)


```


model based on income
```{r}
income_reg = lm(rate ~ med_income, data = hc_df)
# step 1
fit1 <- update(income_reg, . ~ . +unemployment)
tidy(fit1)
fit2 <- update(income_reg, . ~ . +urbanization)
tidy(fit2)
fit3 <- update(income_reg, . ~ . +gini_index)
tidy(fit3)
fit4 <- update(income_reg, . ~ . +high_degree)
tidy(fit4)
fit5 <- update(income_reg, . ~ . +non_citizen)
tidy(fit5)
fit6 <- update(income_reg, . ~ . +non_white)
tidy(fit6) 

forward1 = update(income_reg, . ~ . +gini_index)

#step 2
fit1 <- update(forward1, . ~ . +unemployment)
tidy(fit1)
fit2 <- update(forward1, . ~ . +urbanization)
tidy(fit2)
fit3 <- update(forward1, . ~ . +high_degree)
tidy(fit3)
fit4 <- update(forward1, . ~ . +non_citizen)
tidy(fit4)
fit5 <- update(forward1, . ~ . +non_white)
tidy(fit5)


```

outcome: rate ~ med_income + gini_index


# InteractIon check

urbanization & high_degree

```{r}
##Urbanization -- high_degree
hc_df %>% 
  ggplot(aes(x = high_degree, y = rate, color = factor(urbanization))) +
  geom_point() +
  stat_smooth(method = "lm", se = F)
```


urbanization & gini_index

```{r}
##Urbanization -- gini
hc_df %>% 
  ggplot(aes(x = gini_index, y = rate, color = factor(urbanization))) +
  geom_point() +
  stat_smooth(method = "lm", se = F)

```

urbanization & income

```{r}
hc_df %>% 
  ggplot(aes(x = med_income, y = rate, color = factor(urbanization))) +
  geom_point() +
  stat_smooth(method = "lm", se = F)
```


unemployment & high_degree

```{r}
##Unemployment -- high_degree
hc_df %>% 
  ggplot(aes(x = high_degree, y = rate, color = factor(unemployment))) +
  geom_point() +
  stat_smooth(method = "lm", se = F)

```

unemployment & gini
```{r}
##Unemployment -- gini
hc_df %>% 
  ggplot(aes(x = gini_index, y = rate, color = factor(unemployment))) +
  geom_point() +
  stat_smooth(method = "lm", se = F)

```

unemployment & income

```{r}
hc_df %>% 
  ggplot(aes(x = med_income, y = rate, color = factor(unemployment))) +
  geom_point() +
  stat_smooth(method = "lm", se = F)
```

We check the interaction for `urbanization` and `unemployment` among `income`, `high_degree`, and `gini_index` and find that the three variables all have interactions with urbanizaiotn and unemployment. Next step, we will check whether the interaction term is significant.


# add interaction to model and check significance

initial:

```{r}
aic = 
  hc_df %>% 
  lm(rate ~ high_degree + gini_index, data = .)

summary(aic)

income_main = 
  hc_df %>% 
  lm(rate ~ med_income + gini_index, data = . )
summary(income_main)

```

add interaction: 

1. check for adding all interactions for the two models

```{r}
inter_model_aic = 
  hc_df %>% 
  lm(rate ~ high_degree + gini_index + high_degree * urbanization + high_degree * unemployment + gini_index * urbanization + gini_index * unemployment, data = .)

summary(inter_model_aic)
```

```{r}
inter_model_baseon_income = 
  hc_df %>% 
  lm(rate ~ med_income + gini_index + gini_index * urbanization + gini_index * unemployment + med_income * urbanization + med_income * unemployment, data = .)

summary(inter_model_baseon_income)
```

2. check adding interaction for a main predictor

```{r}
inter_model_gini = 
  hc_df %>% 
  lm(rate ~ gini_index + gini_index * unemployment + gini_index * urbanization, data = .)

summary(inter_model_gini)
```


```{r}
inter_model_highdegree = 
  hc_df %>% 
  lm(rate ~ high_degree + high_degree * unemployment + high_degree * urbanization, data = .)

summary(inter_model_highdegree)
```


```{r}
inter_model_income = 
  hc_df %>% 
  lm(rate ~ med_income + med_income * unemployment + med_income * urbanization, data = .)

summary(inter_model_income)
```

Conclude: we find that the interaction terms are not significant, and we will not add them into the models.

Model 1: rate ~ high_degree + gini_index

Model 2: rate ~ income + gini_index

```{r}
model_1 = lm(rate ~ high_degree + gini_index, data = hc_df)
model_2 = lm(rate ~ med_income + gini_index, data = hc_df)
model = lm(rate ~ ., data = hc_df)
```


```{r}
cp_1 = ols_mallows_cp(model_1, model)
cp_2 = ols_mallows_cp(model_2, model)
```

```{r}
mse_1 = get_mse(model_1, var.estimate = FALSE)
mse_2 = get_mse(model_2, var.estimate = FALSE)
```

```{r}
model_1_summ = summary(model_1)
model_2_summ = summary(model_2)

model_1_summ$adj.r.squared
model_2_summ$adj.r.squared
```



```{r}
par(mfrow=c(2,2))
plot(model_1)
```
```{r}
par(mfrow=c(2,2))
plot(model_2)
```

